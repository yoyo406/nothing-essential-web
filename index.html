<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mémoire - Essential Space</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSIxMjAiIGZpbGw9ImJsYWNrIi8+PGNpcmNsZSBjeD0iMjU2IiBjeT0iMjU2IiByPSIxNDUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtZGFzaGFycmF5PSIxIDE1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIG9wYWNpdH09IjAuOCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTE1IiBzdHJva2U9IiM0NDQiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtZGFzaGFycmF5PSIxIDEyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI4IiBmaWxsPSIjRUI0NDMyIj48YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiB2YWx1ZXM9IjE7MC43OzEiIGR1cj0iM3MiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiAvPjwvY2lyY2xlPjx0ZXh0IHg9IjUwJSIgeT0iNDI1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxldHRlci1zcGFjaW5nPSI2IiBvcGFjaXR5PSIwLjYiPkVTU0VOVElBTCBTUEFDRTwvdGV4dD48L3N2Zz4=">

<style>
:root {
  --bg: #000000;
  --card: #111111;
  --text-main: #FFFFFF;
  --text-dim: #888888;
  --accent-red: #EB4432;
  --border: #222222;
  --dot-font: 'Space Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 120px; touch-action: pan-y; }

/* ── HEADER & SEARCH ── */
.app-header { position: sticky; top: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.logo { font-family: var(--dot-font); font-weight: 700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; }
.header-icon { color: var(--text-dim); cursor: pointer; padding: 5px; }
.header-icon:active { color: white; }

.search-container { padding: 16px 20px 0 20px; }
.search-bar { background: var(--card); border: 1px solid var(--border); border-radius: 100px; padding: 12px 20px; display: flex; align-items: center; gap: 10px; }
.search-bar input { background: none; border: none; outline: none; color: white; width: 100%; font-size: 14px; font-family: 'Inter', sans-serif; }

/* ── GRID & CARDS ── */
.cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 20px; }
.card { background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid var(--border); transition: transform 0.2s, background 0.2s; display: flex; flex-direction: column; justify-content: space-between; min-height: 160px; position: relative; overflow: hidden; }
.card.pressing { transform: scale(0.94); background: #1a1a1a; }
.card.pinned { border: 1px solid #444; }
.pin-dot { position: absolute; top: 15px; right: 15px; width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; box-shadow: 0 0 10px var(--accent-red); }

.card-type { font-family: var(--dot-font); font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; }
.card-title { font-weight: 600; font-size: 16px; margin-bottom: 6px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card-content { font-size: 13px; color: var(--text-dim); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; word-break: break-word; }
.card-date { font-family: var(--dot-font); font-size: 9px; color: var(--text-dim); margin-top: 15px; }

/* Media styling inside cards */
.card-image { width: 100%; height: 80px; object-fit: cover; border-radius: 12px; margin-bottom: 8px; filter: grayscale(20%); }
.card-audio { width: 100%; height: 30px; margin-top: 8px; filter: invert(1) hue-rotate(180deg); }

/* ── MENUS (CONTEXT & HEADER) ── */
.context-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 3000; display: none; align-items: center; justify-content: center; }
.header-menu-overlay { position: fixed; inset: 0; z-index: 3000; display: none; justify-content: flex-end; align-items: flex-start; padding: 60px 20px; }
.menu-box { background: #1a1a1a; border: 1px solid var(--border); border-radius: 28px; width: 240px; padding: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); animation: pop 0.2s ease-out; }
@keyframes pop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.menu-item { padding: 15px; display: flex; align-items: center; gap: 12px; color: white; font-size: 14px; font-weight: 500; border-radius: 20px; cursor: pointer; }
.menu-item:active { background: #333; }
.menu-item.delete { color: var(--accent-red); }

/* ── POPUPS & MODALS ── */
.popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; }
.choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 85%; }
.choice-item { background: var(--card); border: 1px solid var(--border); border-radius: 32px; aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
.choice-item span { font-family: var(--dot-font); font-size: 11px; text-transform: uppercase; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2500; display: none; align-items: flex-end; }
.modal-sheet { background: var(--card); width: 100%; border-radius: 32px 32px 0 0; padding: 30px 20px; border-top: 1px solid var(--border); transition: transform 0.3s ease-out; transform: translateY(100%); max-height: 90vh; overflow-y: auto; }
.modal-overlay.active .modal-sheet { transform: translateY(0); }

.modal-sheet input[type="text"], .modal-sheet textarea { width: 100%; background: #1a1a1a; border: 1px solid var(--border); border-radius: 16px; padding: 16px; color: white; margin-bottom: 12px; outline: none; font-size: 16px; font-family: 'Inter', sans-serif;}
.save-btn { width: 100%; padding: 18px; background: white; color: black; border: none; border-radius: 100px; font-weight: 700; font-family: var(--dot-font); margin-top: 10px;}
.record-btn { width: 100%; padding: 20px; background: var(--accent-red); color: white; border: none; border-radius: 100px; font-weight: 700; font-family: var(--dot-font); margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; }
.record-btn.recording { animation: pulse 1.5s infinite; background: #800000; }

@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(0.98); } 100% { transform: scale(1); } }

.fab { position: fixed; bottom: 30px; right: 24px; background: white; color: black; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: pointer; }

/* Image Preview */
#preview-img { width: 100%; max-height: 200px; object-fit: contain; border-radius: 16px; display: none; margin-bottom: 12px; border: 1px solid var(--border); }
#audio-preview { width: 100%; display: none; margin-bottom: 12px; filter: invert(1); }
</style>
</head>
<body>

<header class="app-header">
  <div class="logo">ESSENTIAL SPACE</div>
  <span class="material-icons-round header-icon" onclick="openHeaderMenu()">more_vert</span>
</header>

<div class="search-container">
    <div class="search-bar">
        <span class="material-icons-round" style="color:var(--text-dim)">search</span>
        <input type="text" placeholder="Rechercher..." oninput="search(this.value)">
    </div>
</div>

<div class="cards-grid" id="container"></div>

<div class="fab" onclick="toggleChoice(true)">
  <span class="material-icons-round" style="font-size: 32px;">add</span>
</div>

<input type="file" id="image-input" accept="image/*" style="display: none;">
<input type="file" id="import-input" accept=".json" style="display: none;" onchange="importData(event)">

<div class="header-menu-overlay" id="header-menu-overlay" onclick="closeHeaderMenu()">
    <div class="menu-box" onclick="event.stopPropagation()">
        <div class="menu-item" onclick="exportData()">
            <span class="material-icons-round">share</span> Partager / Exporter
        </div>
        <div class="menu-item" onclick="triggerImport()">
            <span class="material-icons-round">upload</span> Restaurer (Import)
        </div>
        <div class="menu-item delete" onclick="if(confirm('Tout effacer ?')) { localStorage.clear(); location.reload(); }">
            <span class="material-icons-round">delete_sweep</span> Effacer la mémoire
        </div>
    </div>
</div>

<div class="popup-overlay" id="choice-popup" onclick="toggleChoice(false)">
  <div class="choice-grid" onclick="event.stopPropagation()">
    <div class="choice-item" onclick="openForm('écrit')"><span class="material-icons-round">edit</span><span>Écrit</span></div>
    <div class="choice-item" onclick="openForm('lien')"><span class="material-icons-round">link</span><span>Lien</span></div>
    <div class="choice-item" onclick="handleImageClick()"><span class="material-icons-round">image</span><span>Image</span></div>
    <div class="choice-item" onclick="openForm('vocale')"><span class="material-icons-round" style="color:var(--accent-red)">mic</span><span>Vocale</span></div>
  </div>
</div>

<div class="context-overlay" id="context-overlay" onclick="closeContextMenu()">
    <div class="menu-box" onclick="event.stopPropagation()">
        <div class="menu-item" id="pin-text" onclick="handleMenuAction('pin')"><span class="material-icons-round">push_pin</span> Épingler</div>
        <div class="menu-item delete" onclick="handleMenuAction('delete')"><span class="material-icons-round">delete</span> Supprimer</div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal-sheet" id="modal-sheet">
    <div id="form-title" style="font-family: var(--dot-font); margin-bottom: 20px; text-transform: uppercase; font-size: 11px; color: var(--text-dim)">Nouveau</div>
    
    <input type="text" id="title" placeholder="Titre (optionnel)">
    
    <img id="preview-img" src="" alt="Aperçu">
    
    <button id="record-btn" class="record-btn" style="display: none;" onclick="toggleRecording()">
        <span class="material-icons-round">mic</span> Démarrer l'enregistrement
    </button>
    <audio id="audio-preview" controls></audio>
    
    <textarea id="content" placeholder="Ajouter une note ou un lien..." rows="4"></textarea>
    
    <button class="save-btn" onclick="save()">ENREGISTRER</button>
    <button onclick="closeForm()" style="width:100%; background:none; border:none; color:var(--text-dim); margin-top:15px; font-size: 11px; font-family: var(--dot-font)">ANNULER</button>
  </div>
</div>

<script>
let items = JSON.parse(localStorage.getItem('nothing_media_v2')) || [];
let currentType = 'écrit';
let selectedIndex = null;
let pressTimer = null;
let isScrolling = false;

// Variables pour les médias
let currentMediaData = null;
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

window.addEventListener('touchmove', () => { isScrolling = true; clearTimeout(pressTimer); }, {passive: true});
window.addEventListener('touchstart', () => { isScrolling = false; }, {passive: true});

function render(data = items) {
    const container = document.getElementById('container');
    if (data.length === 0) {
        container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding: 50px; color: var(--text-dim); font-family: var(--dot-font); font-size:12px;">AUCUNE NOTE</div>`;
        return;
    }
    container.innerHTML = data.map((item, i) => {
        let mediaHtml = '';
        if (item.type === 'image' && item.media) {
            mediaHtml = `<img src="${item.media}" class="card-image" alt="Note image">`;
        } else if (item.type === 'vocale' && item.media) {
            mediaHtml = `<audio src="${item.media}" class="card-audio" controls></audio>`;
        }

        const spanClass = (item.type === 'image' || item.type === 'vocale') ? 'style="grid-column: span 2;"' : '';

        return `
        <div class="card ${item.pinned ? 'pinned' : ''}" ${spanClass}
             onmousedown="handlePressStart(${i}, event)" onmouseup="handlePressEnd(event)" 
             ontouchstart="handlePressStart(${i}, event)" ontouchend="handlePressEnd(event)">
            ${item.pinned ? '<div class="pin-dot"></div>' : ''}
            <div>
                <div class="card-type">${item.type}</div>
                ${item.title ? `<div class="card-title">${item.title}</div>` : ''}
                ${mediaHtml}
                ${item.content ? `<div class="card-content">${item.content}</div>` : ''}
            </div>
            <div class="card-date">${item.date}</div>
        </div>
        `;
    }).join('');
}

// --- GESTION APPUI LONG ---
function handlePressStart(index, e) {
    if(e.target.tagName.toLowerCase() === 'audio' || e.target.tagName.toLowerCase() === 'input') return;
    if (isScrolling) return;
    const card = e.currentTarget;
    card.classList.add('pressing');
    pressTimer = setTimeout(() => {
        card.classList.remove('pressing');
        openContextMenu(index);
    }, 600);
}

function handlePressEnd(e) {
    clearTimeout(pressTimer);
    e.currentTarget.classList.remove('pressing');
}

function openContextMenu(index) {
    selectedIndex = index;
    const isPinned = items[index].pinned;
    document.getElementById('pin-text').innerHTML = isPinned ? `<span class="material-icons-round">push_pin</span> Détacher` : `<span class="material-icons-round">push_pin</span> Épingler`;
    document.getElementById('context-overlay').style.display = 'flex';
    if (window.navigator.vibrate) window.navigator.vibrate(50);
}

function closeContextMenu() { document.getElementById('context-overlay').style.display = 'none'; }

function handleMenuAction(action) {
    closeContextMenu();
    if (action === 'delete') {
        items.splice(selectedIndex, 1);
    } else if (action === 'pin') {
        items[selectedIndex].pinned = !items[selectedIndex].pinned;
        items.sort((a, b) => b.pinned - a.pinned);
    }
    saveAndRefresh();
}

// --- HEADER MENU (EXPORT / IMPORT) ---
function openHeaderMenu() { document.getElementById('header-menu-overlay').style.display = 'flex'; }
function closeHeaderMenu() { document.getElementById('header-menu-overlay').style.display = 'none'; }

// Exportation (Web Share API)
async function exportData() {
    closeHeaderMenu();
    if (items.length === 0) return alert("Aucune donnée à sauvegarder.");
    
    const dataStr = JSON.stringify(items, null, 2);
    
    if (navigator.share) {
        try {
            const file = new File([dataStr], 'essential_space_backup.json', { type: 'application/json' });
            await navigator.share({
                title: 'Sauvegarde Essential Space',
                files: [file]
            });
        } catch (err) {
            navigator.share({
                title: 'Sauvegarde Essential Space (Texte)',
                text: dataStr
            });
        }
    } else {
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const date = new Date();
        const formattedDate = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
        a.download = `essential_space_backup_${formattedDate}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
}

function triggerImport() {
    closeHeaderMenu();
    document.getElementById('import-input').click();
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedItems = JSON.parse(e.target.result);
            if (Array.isArray(importedItems)) {
                if (confirm("Attention : L'importation remplacera toutes vos notes actuelles. Continuer ?")) {
                    items = importedItems;
                    saveAndRefresh();
                    alert("Sauvegarde importée avec succès !");
                }
            } else {
                alert("Le format du fichier n'est pas valide.");
            }
        } catch (error) {
            alert("Erreur lors de la lecture du fichier de sauvegarde.");
        }
        event.target.value = ''; 
    };
    reader.readAsText(file);
}

// --- GESTION DES FICHIERS ET MEDIAS ---
function handleImageClick() {
    toggleChoice(false);
    document.getElementById('image-input').click();
}

document.getElementById('image-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
        currentMediaData = event.target.result;
        openForm('image');
    };
    reader.readAsDataURL(file);
});

// --- ENREGISTREMENT AUDIO ---
async function toggleRecording() {
    const btn = document.getElementById('record-btn');
    
    if (!isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentMediaData = event.target.result;
                    const audioPreview = document.getElementById('audio-preview');
                    audioPreview.src = currentMediaData;
                    audioPreview.style.display = 'block';
                };
                reader.readAsDataURL(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            isRecording = true;
            btn.classList.add('recording');
            btn.innerHTML = `<span class="material-icons-round">stop</span> Arrêter l'enregistrement`;
        } catch (err) {
            alert("Accès au microphone refusé ou introuvable.");
        }
    } else {
        mediaRecorder.stop();
        isRecording = false;
        btn.classList.remove('recording');
        btn.innerHTML = `<span class="material-icons-round">mic</span> Réenregistrer`;
    }
}

// --- FORMULAIRE ---
function toggleChoice(show) { document.getElementById('choice-popup').style.display = show ? 'flex' : 'none'; }

function openForm(type) {
    currentType = type;
    toggleChoice(false);
    
    document.getElementById('title').value = '';
    document.getElementById('content').value = '';
    document.getElementById('preview-img').style.display = 'none';
    document.getElementById('record-btn').style.display = 'none';
    document.getElementById('audio-preview').style.display = 'none';
    if(type !== 'image' && type !== 'vocale') currentMediaData = null;
    
    if (type === 'image' && currentMediaData) {
        document.getElementById('preview-img').src = currentMediaData;
        document.getElementById('preview-img').style.display = 'block';
        document.getElementById('content').placeholder = "Ajouter une légende...";
    } else if (type === 'vocale') {
        document.getElementById('record-btn').style.display = 'flex';
        document.getElementById('record-btn').innerHTML = `<span class="material-icons-round">mic</span> Démarrer l'enregistrement`;
        document.getElementById('content').placeholder = "Notes sur cet audio...";
        isRecording = false;
    } else {
        document.getElementById('content').placeholder = "Contenu de la note...";
    }

    document.getElementById('form-title').innerText = "Nouveau " + type;
    document.getElementById('modal-overlay').style.display = 'flex';
    setTimeout(() => document.getElementById('modal-overlay').classList.add('active'), 10);
}

function closeForm() {
    if(isRecording && mediaRecorder) mediaRecorder.stop();
    document.getElementById('modal-overlay').classList.remove('active');
    setTimeout(() => document.getElementById('modal-overlay').style.display = 'none', 300);
    document.getElementById('image-input').value = '';
}

function save() {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    
    if (!title && !content && !currentMediaData) return alert("La note est vide !");
    if (currentType === 'vocale' && !currentMediaData) return alert("Veuillez enregistrer un audio d'abord.");

    const now = new Date();
    const dateStr = `${now.getDate().toString().padStart(2, '0')}.${(now.getMonth()+1).toString().padStart(2, '0')}.${now.getFullYear().toString().slice(-2)}`;

    items.unshift({ title, content, type: currentType, date: dateStr, pinned: false, media: currentMediaData });
    
    saveAndRefresh();
    closeForm();
}

function saveAndRefresh() {
    try {
        localStorage.setItem('nothing_media_v2', JSON.stringify(items));
        render();
    } catch (e) {
        if (e.name === 'QuotaExceededError') {
            alert("L'espace de stockage est plein ! Supprimez d'anciennes images ou faites un export de sauvegarde.");
            items.shift();
        }
    }
}

function search(q) {
    const filtered = items.filter(i => 
        (i.title && i.title.toLowerCase().includes(q.toLowerCase())) || 
        (i.content && i.content.toLowerCase().includes(q.toLowerCase()))
    );
    render(filtered);
}

render();
</script>
</body>
</html>
