<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Essential Space</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<style>
/* ‚îÄ‚îÄ VARIABLES ‚îÄ‚îÄ */
:root {
  --bg: #000000;
  --card: #111111;
  --text-main: #FFFFFF;
  --text-dim: #888888;
  --accent-red: #EB4432;
  --border: #222222;
  --dot-font: 'Space Mono', monospace;
}
body.light-theme {
  --bg: #F5F5F5;
  --card: #FFFFFF;
  --text-main: #111111;
  --text-dim: #777777;
  --border: #E0E0E0;
}

/* ‚îÄ‚îÄ BASE ‚îÄ‚îÄ */
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 120px; overflow-x: hidden; transition: background 0.2s, color 0.2s; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.app-header {
  position: sticky; top: 0; z-index: 1000;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
  padding: 20px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
body.light-theme .app-header { background: rgba(245,245,245,0.85); }
.logo { font-family: var(--dot-font); font-weight: 700; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; }

/* ‚îÄ‚îÄ RECHERCHE ‚îÄ‚îÄ */
.search-container { padding: 16px 20px 0; background: var(--bg); }
.search-bar { background: #111111; border: 1px solid #222222; border-radius: 24px; padding: 14px 20px; display: flex; align-items: center; gap: 12px; }
body.light-theme .search-bar { background: #EBEBEB; border-color: #D8D8D8; }
.search-bar .material-icons-round { color: #777; font-size: 20px; }
.search-bar input { background: none; border: none; outline: none; color: var(--text-main); width: 100%; font-size: 15px; font-family: 'Inter', sans-serif; }
.search-bar input::placeholder { color: var(--text-dim); }

/* ‚îÄ‚îÄ GRILLE & CARTES ‚îÄ‚îÄ */
.cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 20px; }
.card { background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid var(--border); transition: transform 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; cursor: pointer; }
.card.pressing { transform: scale(0.95); }
body:not(.light-theme) .card.pressing { background: #1a1a1a; }
body.light-theme .card.pressing { background: #EFEFEF; }
.pin-dot { position: absolute; top: 15px; right: 15px; width: 6px; height: 6px; background: var(--accent-red); border-radius: 50%; box-shadow: 0 0 8px var(--accent-red); }
.card-type { font-family: var(--dot-font); font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; }
.card-title { font-weight: 600; font-size: 15px; color: var(--text-main); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card-content { font-size: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.card-image { width: 100%; height: 80px; object-fit: cover; border-radius: 12px; margin-bottom: 8px; }
.card-audio { width: 100%; height: 30px; margin-top: 8px; }
body:not(.light-theme) .card-audio { filter: invert(1); }
.card-list { padding-left: 16px; margin: 6px 0; font-size: 12px; color: var(--text-main); }
.card-list li { margin-bottom: 6px; }

/* ‚îÄ‚îÄ SPEED DIAL ‚îÄ‚îÄ */
.popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px); z-index: 2000; display: none; flex-direction: column; align-items: flex-end; justify-content: flex-end; padding: 30px 24px 110px 24px; }
.speed-dial-list { display: flex; flex-direction: column; gap: 12px; align-items: flex-end; width: 100%; }
.dial-item { background: #222; border-radius: 100px; padding: 12px 24px; display: flex; align-items: center; gap: 16px; opacity: 0; transform: translateY(20px); border: 1px solid #333; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); }
body.light-theme .dial-item { background: #FFFFFF; border-color: #E0E0E0; }
.popup-overlay.active .dial-item { opacity: 1; transform: translateY(0); }
.popup-overlay.active .dial-item:nth-child(1) { transition-delay: 0.2s; }
.popup-overlay.active .dial-item:nth-child(2) { transition-delay: 0.15s; }
.popup-overlay.active .dial-item:nth-child(3) { transition-delay: 0.1s; }
.popup-overlay.active .dial-item:nth-child(4) { transition-delay: 0.05s; }
.popup-overlay.active .dial-item:nth-child(5) { transition-delay: 0.02s; }
.dial-item .dial-label { font-family: var(--dot-font); font-size: 13px; text-transform: uppercase; color: var(--text-main); }
.dial-item .material-icons-round { color: var(--text-main); }

/* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
.fab-container { position: fixed; bottom: 30px; right: 24px; z-index: 2500; }
.fab { background: white; color: black; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: transform 0.3s, background 0.3s; }
body.light-theme .fab { background: #111111; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.fab.active { transform: rotate(45deg); background: var(--accent-red) !important; color: white !important; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2500; display: none; align-items: flex-end; }
.modal-sheet { background: var(--card); width: 100%; border-radius: 32px 32px 0 0; padding: 30px 20px; border-top: 1px solid var(--border); transition: transform 0.3s ease-out; transform: translateY(100%); max-height: 90vh; overflow-y: auto; }
.modal-overlay.active .modal-sheet { transform: translateY(0); }
.modal-sheet input, .modal-sheet textarea { width: 100%; background: #1a1a1a; border: 1px solid var(--border); border-radius: 16px; padding: 16px; color: white; margin-bottom: 12px; outline: none; font-size: 16px; font-family: 'Inter', sans-serif; display: block; }
body.light-theme .modal-sheet input, body.light-theme .modal-sheet textarea { background: #F0F0F0; color: #111111; }
.modal-sheet input::placeholder, .modal-sheet textarea::placeholder { color: #666; opacity: 1; }
body.light-theme .modal-sheet input::placeholder, body.light-theme .modal-sheet textarea::placeholder { color: #AAAAAA; }

/* ‚îÄ‚îÄ PALETTE ‚îÄ‚îÄ */
.color-picker { display: flex; gap: 10px; margin-bottom: 20px; }
.color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; flex-shrink: 0; }
.color-btn.active { outline: 2px solid var(--text-main); outline-offset: 2px; }
.color-btn.white-btn { border-color: #999; }
body.light-theme .color-btn.white-btn { border-color: #CCCCCC; }

/* ‚îÄ‚îÄ ACTIONS MODAL ‚îÄ‚îÄ */
.action-bar { display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid var(--border); margin-top: 10px; }
.action-btn { background: none; border: none; color: var(--text-dim); display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 10px; font-family: var(--dot-font); cursor: pointer; }
.action-btn.active { color: var(--accent-red); }
.action-btn.delete { color: #ff4444; }
.save-btn { width: 100%; padding: 18px; background: white; color: black; border: none; border-radius: 100px; font-weight: 700; font-family: var(--dot-font); cursor: pointer; }
body.light-theme .save-btn { background: #111111; color: white; }

/* ‚îÄ‚îÄ PARAM√àTRES ‚îÄ‚îÄ */
.settings-overlay { position: fixed; inset: 0; z-index: 3000; display: none; flex-direction: column; background: var(--bg); }
.settings-overlay.active { display: flex; }
.settings-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
.settings-title { font-family: var(--dot-font); font-size: 13px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-main); }
.settings-close { background: none; border: none; color: var(--text-dim); cursor: pointer; }
.settings-scroll { overflow-y: auto; flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
.settings-section-label { font-family: var(--dot-font); font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin: 12px 0 6px 4px; }
.settings-item { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 16px 20px; display: flex; align-items: center; gap: 14px; cursor: pointer; }
.settings-item-icon { color: var(--text-dim); }
.settings-item-label { font-size: 15px; color: var(--text-main); flex: 1; }
.settings-item-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
.settings-item-arrow { color: var(--text-dim); font-size: 18px; }
.theme-options { display: flex; gap: 8px; margin-top: 8px; width: 100%; }
.theme-option { flex: 1; padding: 10px; border-radius: 14px; border: 2px solid var(--border); display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; font-family: var(--dot-font); font-size: 8px; color: var(--text-dim); text-transform: uppercase; transition: border-color 0.2s, color 0.2s; }
.theme-option.selected { border-color: var(--accent-red); color: var(--accent-red); }
.theme-option-preview { width: 36px; height: 24px; border-radius: 8px; border: 1px solid var(--border); }
.preview-dark { background: #111; }
.preview-light { background: #F5F5F5; }
.preview-auto { background: linear-gradient(135deg, #111 50%, #F5F5F5 50%); }

/* ‚îÄ‚îÄ ASTUCES ‚îÄ‚îÄ */
.tips-overlay { position: fixed; inset: 0; z-index: 3500; display: none; flex-direction: column; background: var(--bg); }
.tips-overlay.active { display: flex; }
.tips-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
.tips-header-title { font-family: var(--dot-font); font-size: 13px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-main); }
.tips-close { background: none; border: none; color: var(--text-dim); cursor: pointer; }
.tips-scroll { overflow-y: auto; flex: 1; padding: 16px; }
.tips-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.tip-card { background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid var(--border); min-height: 150px; display: flex; flex-direction: column; justify-content: space-between; }
.tip-card-icon { font-size: 26px; margin-bottom: 10px; }
.tip-card-title { font-weight: 600; font-size: 13px; color: var(--text-main); margin-bottom: 6px; }
.tip-card-body { font-size: 11px; line-height: 1.5; color: var(--text-dim); flex: 1; }
.tip-card-tag { font-family: var(--dot-font); font-size: 8px; color: var(--accent-red); text-transform: uppercase; margin-top: 10px; }

/* small helper for list editor */
.list-editor { display:flex; gap:8px; margin-bottom:12px; }
.list-editor input { flex:1; }
.list-item { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.list-item button { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:14px; }
</style>
</head>
<body>

<header class="app-header">
  <div class="logo">ESSENTIAL SPACE</div>
  <div style="display:flex; align-items:center; gap:14px;">
    <span class="material-icons-round" style="color:var(--text-dim); cursor:pointer;" onclick="toggleTips(true)">help_outline</span>
    <span class="material-icons-round" style="color:var(--text-dim); cursor:pointer;" onclick="toggleSettings(true)">settings</span>
  </div>
</header>

<div class="search-container">
  <div class="search-bar">
    <span class="material-icons-round">search</span>
    <input type="text" id="search-input" placeholder="Rechercher..." oninput="search(this.value)">
  </div>
</div>

<div class="cards-grid" id="container"></div>

<div class="fab-container">
  <div class="fab" id="main-fab" onclick="togglePopup()">
    <span class="material-icons-round" style="font-size:32px;">add</span>
  </div>
</div>

<div class="popup-overlay" id="choice-popup" onclick="togglePopup()">
  <div class="speed-dial-list" onclick="event.stopPropagation()">
    <div class="dial-item" onclick="openForm('√©crit')">
      <span class="material-icons-round">notes</span>
      <span class="dial-label">√âcrit</span>
    </div>
    <div class="dial-item" onclick="openForm('lien')">
      <span class="material-icons-round">link</span>
      <span class="dial-label">Lien</span>
    </div>
    <div class="dial-item" onclick="handleImageClick()">
      <span class="material-icons-round">photo_library</span>
      <span class="dial-label">Image</span>
    </div>
    <div class="dial-item" onclick="openForm('vocale')">
      <span class="material-icons-round" style="color:var(--accent-red)">mic</span>
      <span class="dial-label">Vocale</span>
    </div>
    <div class="dial-item" onclick="openForm('liste')">
      <span class="material-icons-round">format_list_bulleted</span>
      <span class="dial-label">Liste</span>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal-sheet">
    <div id="modal-label" style="font-family:var(--dot-font); margin-bottom:15px; font-size:10px; color:var(--text-dim); text-transform:uppercase;">NOUVEAU</div>

    <input type="text" id="note-title" placeholder="Titre (optionnel)">

    <img id="preview-img" style="width:100%; max-height:200px; object-fit:contain; display:none; border-radius:16px; margin-bottom:12px; border:1px solid var(--border);" alt="">

    <button id="record-btn" style="width:100%; padding:15px; background:var(--accent-red); color:white; border-radius:50px; border:none; margin-bottom:12px; display:none; font-family:var(--dot-font); font-weight:700; cursor:pointer;" onclick="toggleRecording()">MICRO</button>

    <audio id="audio-preview" controls style="display:none; width:100%; margin-bottom:12px;"></audio>

    <textarea id="note-content" placeholder="Contenu..." rows="6"></textarea>

    <!-- Liste editor -->
    <div id="list-editor-ui" style="display:none;">
      <div class="list-editor">
        <input id="list-item-input" placeholder="Nouvel √©l√©ment">
        <button class="save-btn" style="padding:10px 14px; border-radius:12px; width:auto;" onclick="addListItem()">AJOUTER</button>
      </div>
      <div id="list-items-container"></div>
    </div>

    <div class="color-picker" id="color-picker-ui">
      <div class="color-btn white-btn" id="cbtn-default" style="background:#FFFFFF" onclick="setTextColor('default')"></div>
      <div class="color-btn" id="cbtn-red"    style="background:#EB4432" onclick="setTextColor('#EB4432')"></div>
      <div class="color-btn" id="cbtn-yellow" style="background:#FFD700" onclick="setTextColor('#FFD700')"></div>
      <div class="color-btn" id="cbtn-green"  style="background:#00FF7F" onclick="setTextColor('#00FF7F')"></div>
      <div class="color-btn" id="cbtn-blue"   style="background:#00BFFF" onclick="setTextColor('#00BFFF')"></div>
    </div>

    <button class="save-btn" onclick="saveNote()">ENREGISTRER</button>

    <div class="action-bar" id="edit-actions" style="display:none;">
      <button class="action-btn" id="pin-btn-modal" onclick="togglePinModal()">
        <span class="material-icons-round">push_pin</span>√âpingler
      </button>
      <button class="action-btn delete" onclick="deleteNoteModal()">
        <span class="material-icons-round">delete</span>Supprimer
      </button>
    </div>

    <button onclick="closeForm()" style="width:100%; background:none; border:none; color:var(--text-dim); margin-top:15px; font-size:11px; font-family:var(--dot-font); cursor:pointer;">FERMER</button>
  </div>
</div>

<div class="settings-overlay" id="settings-overlay">
  <div class="settings-header">
    <span class="settings-title">‚öôÔ∏è Param√®tres</span>
    <button class="settings-close" onclick="toggleSettings(false)">
      <span class="material-icons-round">close</span>
    </button>
  </div>
  <div class="settings-scroll">
    <div class="settings-section-label">Apparence</div>
    <div class="settings-item" style="flex-direction:column; align-items:flex-start; cursor:default;">
      <div style="display:flex; align-items:center; gap:14px; width:100%;">
        <span class="material-icons-round settings-item-icon">palette</span>
        <div style="flex:1">
          <div class="settings-item-label">Th√®me</div>
          <div class="settings-item-sub" id="theme-sub-label">Automatique (syst√®me)</div>
        </div>
      </div>
      <div class="theme-options">
        <div class="theme-option" id="theme-opt-dark" onclick="setThemeMode('dark')">
          <div class="theme-option-preview preview-dark"></div>Sombre
        </div>
        <div class="theme-option" id="theme-opt-light" onclick="setThemeMode('light')">
          <div class="theme-option-preview preview-light"></div>Clair
        </div>
        <div class="theme-option" id="theme-opt-auto" onclick="setThemeMode('auto')">
          <div class="theme-option-preview preview-auto"></div>Auto
        </div>
      </div>
    </div>
    <div class="settings-section-label">Donn√©es</div>
    <div class="settings-item" onclick="exportData()">
      <span class="material-icons-round settings-item-icon">share</span>
      <div style="flex:1">
        <div class="settings-item-label">Exporter les notes</div>
        <div class="settings-item-sub">Sauvegarde en fichier JSON</div>
      </div>
      <span class="material-icons-round settings-item-arrow">chevron_right</span>
    </div>
    <div class="settings-item" onclick="triggerImport()">
      <span class="material-icons-round settings-item-icon">upload</span>
      <div style="flex:1">
        <div class="settings-item-label">Importer des notes</div>
        <div class="settings-item-sub">Restaurer depuis un fichier JSON</div>
      </div>
      <span class="material-icons-round settings-item-arrow">chevron_right</span>
    </div>
  </div>
</div>

<div class="tips-overlay" id="tips-overlay">
  <div class="tips-header">
    <span class="tips-header-title">üí° Astuces</span>
    <button class="tips-close" onclick="toggleTips(false)">
      <span class="material-icons-round">close</span>
    </button>
  </div>
  <div class="tips-scroll">
    <div class="tips-grid">
      <div class="tip-card">
        <div class="tip-card-icon">‚úèÔ∏è</div>
        <div><div class="tip-card-title">Cr√©er une note</div>
        <div class="tip-card-body">Appuie sur <strong>+</strong> en bas √† droite pour choisir le type : √©crit, lien, image, vocale ou liste.</div></div>
        <div class="tip-card-tag">D√©marrer</div>
      </div>
      <div class="tip-card">
        <div class="tip-card-icon">üìå</div>
        <div><div class="tip-card-title">√âpingler</div>
        <div class="tip-card-body">Ouvre une note et appuie sur <strong>√âpingler</strong> pour la garder en haut de ta liste.</div></div>
        <div class="tip-card-tag">Organisation</div>
      </div>
      <div class="tip-card">
        <div class="tip-card-icon">üé®</div>
        <div><div class="tip-card-title">Couleur du texte</div>
        <div class="tip-card-body">Utilise la palette de couleurs lors de la cr√©ation pour personnaliser ton contenu.</div></div>
        <div class="tip-card-tag">Personnalisation</div>
      </div>
      <div class="tip-card">
        <div class="tip-card-icon">üîç</div>
        <div><div class="tip-card-title">Recherche rapide</div>
        <div class="tip-card-body">La barre de recherche filtre tes notes par titre ou contenu en temps r√©el.</div></div>
        <div class="tip-card-tag">Recherche</div>
      </div>
      <div class="tip-card">
        <div class="tip-card-icon">üéôÔ∏è</div>
        <div><div class="tip-card-title">Note vocale</div>
        <div class="tip-card-body">Choisis <strong>Vocale</strong> puis MICRO pour enregistrer, STOP pour terminer.</div></div>
        <div class="tip-card-tag">Audio</div>
      </div>
      <div class="tip-card">
        <div class="tip-card-icon">üñºÔ∏è</div>
        <div><div class="tip-card-title">Ajouter une image</div>
        <div class="tip-card-body">Choisis <strong>Image</strong> pour s√©lectionner une photo depuis ta galerie.</div></div>
        <div class="tip-card-tag">M√©dia</div>
      </div>
      <div class="tip-card">
        <div class="tip-card-icon">üíæ</div>
        <div><div class="tip-card-title">Exporter / Importer</div>
        <div class="tip-card-body">Via <strong>‚öôÔ∏è</strong> en haut √† droite, exporte tes notes en JSON pour les sauvegarder.</div></div>
        <div class="tip-card-tag">Sauvegarde</div>
      </div>
      <div class="tip-card">
        <div class="tip-card-icon">üåó</div>
        <div><div class="tip-card-title">Th√®me</div>
        <div class="tip-card-body">Via <strong>‚öôÔ∏è</strong>, choisis Sombre, Clair, ou Auto (suit ton appareil).</div></div>
        <div class="tip-card-tag">Affichage</div>
      </div>
    </div>
  </div>
</div>

<input type="file" id="image-input" accept="image/*" style="display:none">
<input type="file" id="import-input" accept=".json" style="display:none" onchange="importData(event)">

<script>
// ‚îÄ‚îÄ √âTAT GLOBAL ‚îÄ‚îÄ
let items = JSON.parse(localStorage.getItem('essential_space_v2')) || [];
let currentType = '√©crit';
let currentMediaData = null;
let editingIndex = null;
let selectedColor = null; // null = couleur par d√©faut (suit le th√®me)
let mediaRecorder, audioChunks = [], isRecording = false;
let listItems = []; // pour l'√©diteur de listes

// ‚îÄ‚îÄ TH√àME ‚îÄ‚îÄ
let themeMode = localStorage.getItem('essential_theme_mode') || 'auto';

function isCurrentlyDark() {
  return themeMode === 'dark' || (themeMode === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
}

function applyTheme() {
  const dark = isCurrentlyDark();
  document.body.classList.toggle('light-theme', !dark);
  document.querySelector('meta[name="theme-color"]').setAttribute('content', dark ? '#000000' : '#F5F5F5');
  ['dark', 'light', 'auto'].forEach(m => {
    const el = document.getElementById('theme-opt-' + m);
    if (el) el.classList.toggle('selected', themeMode === m);
  });
  const sub = document.getElementById('theme-sub-label');
  if (sub) sub.textContent =
    themeMode === 'auto'  ? 'Automatique (syst√®me)' :
    themeMode === 'light' ? 'Th√®me clair' : 'Th√®me sombre';
  render();
}

function setThemeMode(mode) {
  themeMode = mode;
  localStorage.setItem('essential_theme_mode', mode);
  applyTheme();
}

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  if (themeMode === 'auto') applyTheme();
});

// ‚îÄ‚îÄ UTILITAIRES ‚îÄ‚îÄ
function escapeHtml(str) {
  return String(str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// Couleur par d√©faut du th√®me actuel
function defaultColor() {
  return isCurrentlyDark() ? '#FFFFFF' : '#111111';
}

// ‚îÄ‚îÄ RENDU DES CARTES ‚îÄ‚îÄ
function render(data = items) {
  const container = document.getElementById('container');

  if (!Array.isArray(data) || data.length === 0) {
    container.innerHTML = `<div style="grid-column:span 2; text-align:center; padding:50px; color:var(--text-dim); font-family:var(--dot-font); font-size:10px;">ESPACE VIDE</div>`;
    return;
  }

  container.innerHTML = data.map((item, i) => {
    const span = (item.type === 'image' || item.type === 'vocale') ? 'grid-column:span 2;' : '';
    const textColor = item.color || 'var(--text-main)';

    // Pr√©parer le contenu selon le type
    let contentHtml = '';
    if (item.type === 'image' && item.media) {
      contentHtml = `<img src="${item.media}" class="card-image" alt="">` +
                    `<div class="card-content" style="color:${textColor}">${escapeHtml(item.content || '')}</div>`;
    } else if (item.type === 'vocale' && item.media) {
      contentHtml = `<audio src="${item.media}" class="card-audio" controls onclick="event.stopPropagation()"></audio>`;
      contentHtml += `<div class="card-content" style="color:${textColor}">${escapeHtml(item.content || '')}</div>`;
    } else if (item.type === 'liste' && Array.isArray(item.items)) {
      // Affiche les 3 premiers √©l√©ments de la liste
      const listHtml = item.items.slice(0,3).map(li => `<li>${escapeHtml(li.text)}</li>`).join('');
      contentHtml = `<ul class="card-list" style="color:${textColor}">${listHtml}${item.items.length > 3 ? '<li>‚Ä¶</li>' : ''}</ul>`;
    } else {
      contentHtml = `<div class="card-content" style="color:${textColor}">${escapeHtml(item.content || '')}</div>`;
    }

    return `
      <div class="card" style="${span}" onclick="openEdit(${i})">
        ${item.pinned ? '<div class="pin-dot"></div>' : ''}
        <div>
          <div class="card-type">${escapeHtml(item.type)}</div>
          ${item.title ? `<div class="card-title">${escapeHtml(item.title)}</div>` : ''}
          ${contentHtml}
        </div>
        <div style="font-family:var(--dot-font); font-size:8px; color:var(--text-dim); margin-top:10px">${escapeHtml(item.date || '')}</div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ PALETTE COULEURS ‚îÄ‚îÄ
const COLOR_TO_BTN = {
  'default':  'cbtn-default',
  '#EB4432': 'cbtn-red',
  '#FFD700': 'cbtn-yellow',
  '#00FF7F': 'cbtn-green',
  '#00BFFF': 'cbtn-blue',
};

function setTextColor(color) {
  selectedColor = (color === 'default') ? null : color;
  document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
  const btnId = COLOR_TO_BTN[color] || 'cbtn-default';
  const btn = document.getElementById(btnId);
  if (btn) btn.classList.add('active');
  const textarea = document.getElementById('note-content');
  if (textarea) textarea.style.color = selectedColor || defaultColor();
}

// ‚îÄ‚îÄ LAYOUT MODAL selon le type ‚îÄ‚îÄ
function applyModalLayout(type) {
  const vocale = type === 'vocale';
  const liste  = type === 'liste';
  document.getElementById('note-content').style.display  = (vocale || liste) ? 'none' : 'block';
  document.getElementById('color-picker-ui').style.display = (vocale || liste) ? 'none' : 'flex';
  document.getElementById('record-btn').style.display    = vocale ? 'block' : 'none';
  document.getElementById('preview-img').style.display   = type === 'image' ? 'block' : (document.getElementById('preview-img').src ? 'block' : 'none');
  document.getElementById('list-editor-ui').style.display = liste ? 'block' : 'none';
}

// ‚îÄ‚îÄ R√âINITIALISATION MODAL ‚îÄ‚îÄ
function resetModal() {
  document.getElementById('note-title').value = '';
  document.getElementById('note-content').value = '';
  document.getElementById('preview-img').style.display = 'none';
  document.getElementById('preview-img').src = '';
  document.getElementById('audio-preview').style.display = 'none';
  document.getElementById('audio-preview').src = '';
  document.getElementById('edit-actions').style.display = 'none';
  document.getElementById('record-btn').style.display = 'none';
  document.getElementById('note-content').style.display = 'block';
  document.getElementById('color-picker-ui').style.display = 'flex';
  document.getElementById('list-editor-ui').style.display = 'none';
  document.getElementById('list-items-container').innerHTML = '';
  currentMediaData = null;
  listItems = [];
  setTextColor('default');
}

// ‚îÄ‚îÄ CR√âATION ‚îÄ‚îÄ
function openForm(type) {
  editingIndex = null;
  currentType = type;
  togglePopup();
  resetModal();
  document.getElementById('modal-label').innerText = 'NOUVEAU';
  applyModalLayout(type);
  showModal();
}

// ‚îÄ‚îÄ √âDITION ‚îÄ‚îÄ
function openEdit(index) {
  editingIndex = index;
  const item = items[index];
  resetModal();
  document.getElementById('modal-label').innerText = 'MODIFIER';
  document.getElementById('note-title').value = item.title || '';
  document.getElementById('edit-actions').style.display = 'flex';
  document.getElementById('pin-btn-modal').classList.toggle('active', !!item.pinned);
  applyModalLayout(item.type);

  if (item.type !== 'vocale' && item.type !== 'liste') {
    document.getElementById('note-content').value = item.content || '';
    setTextColor(item.color || 'default');
  }

  if (item.type === 'image' && item.media) {
    document.getElementById('preview-img').src = item.media;
    document.getElementById('preview-img').style.display = 'block';
  }
  if (item.type === 'vocale' && item.media) {
    document.getElementById('audio-preview').src = item.media;
    document.getElementById('audio-preview').style.display = 'block';
  }

  if (item.type === 'liste') {
    listItems = Array.isArray(item.items) ? item.items.map(li => ({ text: li.text, checked: !!li.checked })) : [];
    renderListEditor();
  }

  showModal();
}

// ‚îÄ‚îÄ LIST EDITOR ‚îÄ‚îÄ
function addListItem() {
  const input = document.getElementById('list-item-input');
  const text = (input.value || '').trim();
  if (!text) return;
  listItems.push({ text, checked: false });
  input.value = '';
  renderListEditor();
}

function removeListItem(idx) {
  listItems.splice(idx, 1);
  renderListEditor();
}

function toggleListItemChecked(idx) {
  listItems[idx].checked = !listItems[idx].checked;
  renderListEditor();
}

function renderListEditor() {
  const container = document.getElementById('list-items-container');
  container.innerHTML = '';
  listItems.forEach((li, i) => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <input type="checkbox" ${li.checked ? 'checked' : ''} onchange="toggleListItemChecked(${i})">
      <div style="flex:1; color:var(--text-main); font-size:14px;">${escapeHtml(li.text)}</div>
      <button onclick="removeListItem(${i})" title="Supprimer">‚úï</button>
    `;
    container.appendChild(div);
  });
}

// ‚îÄ‚îÄ SAUVEGARDE ‚îÄ‚îÄ
function saveNote() {
  const title   = document.getElementById('note-title').value.trim();
  const content = document.getElementById('note-content').value.trim();
  const now = new Date();
  const date = `${String(now.getDate()).padStart(2,'0')}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getFullYear()).slice(-2)}`;

  const base = {
    title,
    type: currentType,
    date,
    color: selectedColor,
    media: currentMediaData || (editingIndex !== null ? items[editingIndex].media : null),
    pinned: editingIndex !== null ? items[editingIndex].pinned : false,
  };

  if (currentType === 'liste') {
    base.items = listItems.map(li => ({ text: li.text, checked: !!li.checked }));
    base.content = ''; // obsolete for lists
  } else {
    base.content = content;
    base.items = undefined;
  }

  const note = base;

  if (editingIndex !== null) items[editingIndex] = note;
  else items.unshift(note);

  saveToDisk();
  closeForm();
}

function togglePinModal() {
  if (editingIndex === null) return;
  items[editingIndex].pinned = !items[editingIndex].pinned;
  document.getElementById('pin-btn-modal').classList.toggle('active', items[editingIndex].pinned);
  saveToDisk();
}

function deleteNoteModal() {
  if (editingIndex === null) return;
  if (confirm('Supprimer cette note ?')) {
    items.splice(editingIndex, 1);
    saveToDisk();
    closeForm();
  }
}

// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ
function showModal() {
  const overlay = document.getElementById('modal-overlay');
  overlay.style.display = 'flex';
  setTimeout(() => overlay.classList.add('active'), 10);
}

function closeForm() {
  const overlay = document.getElementById('modal-overlay');
  overlay.classList.remove('active');
  setTimeout(() => { overlay.style.display = 'none'; }, 300);
}

function togglePopup() {
  const popup = document.getElementById('choice-popup');
  const fab   = document.getElementById('main-fab');
  if (!popup.classList.contains('active')) {
    popup.style.display = 'flex';
    fab.classList.add('active');
    setTimeout(() => popup.classList.add('active'), 10);
  } else {
    popup.classList.remove('active');
    fab.classList.remove('active');
    setTimeout(() => { popup.style.display = 'none'; }, 300);
  }
}

function toggleSettings(s) { document.getElementById('settings-overlay').classList.toggle('active', s); }
function toggleTips(s)     { document.getElementById('tips-overlay').classList.toggle('active', s); }

// ‚îÄ‚îÄ PERSISTANCE ‚îÄ‚îÄ
function saveToDisk() {
  items.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));
  localStorage.setItem('essential_space_v2', JSON.stringify(items));
  render();
}

function search(q) {
  const query = (q || '').toLowerCase().trim();
  if (!query) { render(); return; }
  render(items.filter(i => {
    const title = (i.title || '').toLowerCase();
    const content = (i.content || '').toLowerCase();
    const itemsText = Array.isArray(i.items) ? i.items.map(x => x.text).join(' ').toLowerCase() : '';
    return (title + ' ' + content + ' ' + itemsText).includes(query);
  }));
}

// ‚îÄ‚îÄ EXPORT / IMPORT ‚îÄ‚îÄ
function exportData() {
  const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'essential_space_' + new Date().toISOString().slice(0, 10) + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toggleSettings(false);
}

function triggerImport() {
  document.getElementById('import-input').click();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!Array.isArray(imported)) { alert('Fichier invalide.'); return; }
      items = imported;
      saveToDisk();
      toggleSettings(false);
      alert(imported.length + ' note(s) import√©e(s) avec succ√®s.');
    } catch (e) {
      alert('Erreur de lecture du fichier JSON.');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ‚îÄ‚îÄ M√âDIAS ‚îÄ‚îÄ
function handleImageClick() {
  togglePopup();
  document.getElementById('image-input').click();
}

document.getElementById('image-input').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    currentMediaData = ev.target.result;
    openForm('image');
  };
  reader.readAsDataURL(file);
  e.target.value = '';
};

async function toggleRecording() {
  const btn = document.getElementById('record-btn');
  if (!isRecording) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks   = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob   = new Blob(audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.onload = ev => {
          currentMediaData = ev.target.result;
          const audio = document.getElementById('audio-preview');
          audio.src   = ev.target.result;
          audio.style.display = 'block';
        };
        reader.readAsDataURL(blob);
        stream.getTracks().forEach(t => t.stop()); // lib√®re le micro
      };
      mediaRecorder.start();
      isRecording = true;
      btn.innerText = 'STOP';
    } catch (err) {
      alert('Acc√®s au microphone refus√©.');
    }
  } else {
    mediaRecorder.stop();
    isRecording = false;
    btn.innerText = 'MICRO';
  }
}

// ‚îÄ‚îÄ D√âMARRAGE ‚îÄ‚îÄ
applyTheme(); // appelle render() en interne
</script>
</body>
</html>
