<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Essential Space</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSIxMjAiIGZpbGw9ImJsYWNrIi8+PGNpcmNsZSBjeD0iMjU2IiBjeT0iMjU2IiByPSIxNDUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtZGFzaGFycmF5PSIxIDE1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIG9wYWNpdHk9IjAuOCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTE1IiBzdHJva2U9IiM0NDQiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtZGFzaGFycmF5PSIxIDEyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI4IiBmaWxsPSIjRUI0NDMyIj48YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiB2YWx1ZXM9IjE7MC43OzEiIGR1cj0iM3MiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiAvPjwvY2lyY2xlPjx0ZXh0IHg9IjUwJSIgeT0iNDI1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxldHRlci1zcGFjaW5nPSI2IiBvcGFjaXR5PSIwLjYiPkVTU0VOVElBTCBTUEFDRTwvdGV4dD48L3N2Zz4=">

<style>
:root {
  --bg: #000000;
  --card: #111111;
  --text-main: #FFFFFF;
  --text-dim: #888888;
  --accent-red: #EB4432;
  --border: #222222;
  --dot-font: 'Space Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 120px; overflow-x: hidden; }

/* --- HEADER & RECHERCHE --- */
.app-header { position: sticky; top: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.logo { font-family: var(--dot-font); font-weight: 700; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; }

.search-container { padding: 16px 20px 0 20px; background: var(--bg); }
.search-bar { background: #111111; border: 1px solid #222222; border-radius: 24px; padding: 14px 20px; display: flex; align-items: center; gap: 12px; }
.search-bar .material-icons-round { color: #555555; font-size: 20px; }
.search-bar input { background: none; border: none; outline: none; color: #FFFFFF; width: 100%; font-size: 15px; font-family: 'Inter', sans-serif; }
.search-bar input::placeholder { color: #444444; }

/* --- GRID & CARDS --- */
.cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 20px; }
.card { background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid var(--border); transition: transform 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
.card.pressing { transform: scale(0.95); background: #1a1a1a; }
.pin-dot { position: absolute; top: 15px; right: 15px; width: 6px; height: 6px; background: var(--accent-red); border-radius: 50%; box-shadow: 0 0 8px var(--accent-red); }

.card-type { font-family: var(--dot-font); font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; }
.card-title { font-weight: 600; font-size: 15px; color: white; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card-content { font-size: 12px; color: var(--text-dim); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.card-image { width: 100%; height: 80px; object-fit: cover; border-radius: 12px; margin-bottom: 8px; }
.card-audio { width: 100%; height: 30px; margin-top: 8px; filter: invert(1); }

/* --- POPUP SPEED DIAL --- */
.popup-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); z-index: 2000; display: none; flex-direction: column; align-items: flex-end; justify-content: flex-end; padding: 30px 24px 110px 24px; }
.speed-dial-list { display: flex; flex-direction: column; gap: 12px; align-items: flex-end; width: 100%; }
.dial-item { background: #222; border-radius: 100px; padding: 12px 24px; display: flex; align-items: center; gap: 16px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: translateY(20px); border: 1px solid #333; }
.popup-overlay.active .dial-item { opacity: 1; transform: translateY(0); }
.popup-overlay.active .dial-item:nth-child(1) { transition-delay: 0.2s; }
.popup-overlay.active .dial-item:nth-child(2) { transition-delay: 0.15s; }
.popup-overlay.active .dial-item:nth-child(3) { transition-delay: 0.1s; }
.popup-overlay.active .dial-item:nth-child(4) { transition-delay: 0.05s; }
.dial-item span { font-family: var(--dot-font); font-size: 13px; text-transform: uppercase; color: white; letter-spacing: 1px; }
.dial-item .material-icons-round { font-size: 22px; color: white; }

/* --- FAB --- */
.fab-container { position: fixed; bottom: 30px; right: 24px; z-index: 2500; display: flex; flex-direction: column; align-items: flex-end; }
.fab { background: white; color: black; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: transform 0.3s ease; }
.fab.active { transform: rotate(45deg); background: var(--accent-red); color: white; }

/* --- MODAL FORMULAIRE (CORRIGÉ) --- */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2500; display: none; align-items: flex-end; }
.modal-sheet { background: var(--card); width: 100%; border-radius: 32px 32px 0 0; padding: 30px 20px; border-top: 1px solid var(--border); transition: transform 0.3s ease-out; transform: translateY(100%); display: flex; flex-direction: column; }
.modal-overlay.active .modal-sheet { transform: translateY(0); }

/* Fix des zones de saisie */
.modal-sheet input[type="text"], 
.modal-sheet textarea { 
    width: 100%; 
    background: #1a1a1a; 
    border: 1px solid var(--border); 
    border-radius: 16px; 
    padding: 16px; 
    color: white; 
    margin-bottom: 12px; 
    outline: none; 
    font-size: 16px; 
    font-family: 'Inter', sans-serif;
    display: block; /* Force l'empilement vertical */
}

.save-btn { width: 100%; padding: 18px; background: white; color: black; border: none; border-radius: 100px; font-weight: 700; font-family: var(--dot-font); margin-top: 10px; }
#record-btn { width: 100%; padding: 20px; background: var(--accent-red); color: white; border: none; border-radius: 100px; font-weight: 700; font-family: var(--dot-font); display: none; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; }

/* --- MENUS --- */
.header-menu-overlay { position: fixed; inset: 0; z-index: 3000; display: none; justify-content: flex-end; align-items: flex-start; padding: 60px 20px; }
.context-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; }
.menu-box { background: #1a1a1a; border: 1px solid var(--border); border-radius: 28px; width: 240px; padding: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
.menu-item { padding: 15px; display: flex; align-items: center; gap: 12px; color: white; font-size: 14px; border-radius: 20px; }
.menu-item.delete { color: var(--accent-red); }
</style>
</head>
<body>

<header class="app-header">
  <div class="logo">ESSENTIAL SPACE</div>
  <span class="material-icons-round" style="color:var(--text-dim)" onclick="toggleHeaderMenu(true)">more_vert</span>
</header>

<div class="search-container">
    <div class="search-bar">
        <span class="material-icons-round">search</span>
        <input type="text" id="search-input" placeholder="Rechercher..." oninput="search(this.value)">
    </div>
</div>

<div class="cards-grid" id="container"></div>

<div class="fab-container">
    <div class="fab" id="main-fab" onclick="togglePopup()">
        <span class="material-icons-round" style="font-size: 32px;">add</span>
    </div>
</div>

<div class="popup-overlay" id="choice-popup" onclick="togglePopup()">
  <div class="speed-dial-list" onclick="event.stopPropagation()">
    <div class="dial-item" onclick="openForm('écrit')"><span class="material-icons-round">notes</span><span>Écrit</span></div>
    <div class="dial-item" onclick="openForm('lien')"><span class="material-icons-round">link</span><span>Lien</span></div>
    <div class="dial-item" onclick="handleImageClick()"><span class="material-icons-round">photo_library</span><span>Image</span></div>
    <div class="dial-item" onclick="openForm('vocale')"><span class="material-icons-round" style="color:var(--accent-red)">mic</span><span>Vocale</span></div>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal-sheet">
    <div style="font-family: var(--dot-font); margin-bottom: 15px; font-size: 10px; color: var(--text-dim); text-transform: uppercase;">NOUVEAU</div>
    <input type="text" id="title" placeholder="Titre (optionnel)">
    <img id="preview-img" style="width:100%; max-height:180px; object-fit:contain; display:none; border-radius:16px; margin-bottom:12px; border: 1px solid var(--border);">
    <button id="record-btn" onclick="toggleRecording()"><span class="material-icons-round">mic</span> Démarrer</button>
    <audio id="audio-preview" controls style="display:none; width:100%; margin-bottom:12px; filter:invert(1)"></audio>
    <textarea id="content" placeholder="Contenu..." rows="4"></textarea>
    <button class="save-btn" onclick="save()">ENREGISTRER</button>
    <button onclick="closeForm()" style="width:100%; background:none; border:none; color:var(--text-dim); margin-top:15px; font-size:11px; font-family:var(--dot-font)">ANNULER</button>
  </div>
</div>

<div class="header-menu-overlay" id="header-menu-overlay" onclick="toggleHeaderMenu(false)">
    <div class="menu-box" onclick="event.stopPropagation()">
        <div class="menu-item" onclick="exportData()"><span class="material-icons-round">share</span> Partager / Exporter</div>
        <div class="menu-item" onclick="triggerImport()"><span class="material-icons-round">upload</span> Restaurer (Import)</div>
        <div class="menu-item delete" onclick="clearAll()"><span class="material-icons-round">delete_sweep</span> Tout effacer</div>
    </div>
</div>

<div class="context-overlay" id="context-overlay" onclick="closeContextMenu()">
    <div class="menu-box" onclick="event.stopPropagation()">
        <div class="menu-item" id="pin-text" onclick="handleMenuAction('pin')"><span class="material-icons-round">push_pin</span> Épingler</div>
        <div class="menu-item delete" onclick="handleMenuAction('delete')"><span class="material-icons-round">delete</span> Supprimer</div>
    </div>
</div>

<input type="file" id="image-input" accept="image/*" style="display:none">
<input type="file" id="import-input" accept=".json" style="display:none" onchange="importData(event)">

<script>
let items = JSON.parse(localStorage.getItem('essential_space_v2')) || [];
let currentType = 'écrit';
let selectedIndex = null;
let pressTimer = null;
let currentMediaData = null;
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

function render(data = items) {
    const container = document.getElementById('container');
    if (data.length === 0) {
        container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding: 50px; color: var(--text-dim); font-family: var(--dot-font); font-size:10px;">ESPACE VIDE</div>`;
        return;
    }
    container.innerHTML = data.map((item, i) => {
        const span = (item.type === 'image' || item.type === 'vocale') ? 'grid-column: span 2' : '';
        return `
        <div class="card" style="${span}" onmousedown="startPress(${i}, event)" onmouseup="endPress(event)" ontouchstart="startPress(${i}, event)" ontouchend="endPress(event)">
            ${item.pinned ? '<div class="pin-dot"></div>' : ''}
            <div>
                <div class="card-type">${item.type}</div>
                ${item.title ? `<div class="card-title">${item.title}</div>` : ''}
                ${item.type === 'image' && item.media ? `<img src="${item.media}" class="card-image">` : ''}
                ${item.type === 'vocale' && item.media ? `<audio src="${item.media}" class="card-audio" controls></audio>` : ''}
                ${item.content ? `<div class="card-content">${item.content}</div>` : ''}
            </div>
            <div style="font-family:var(--dot-font); font-size:8px; color:var(--text-dim); margin-top:10px">${item.date}</div>
        </div>`;
    }).join('');
}

function search(q) {
    const query = q.toLowerCase().trim();
    if (!query) { render(items); return; }
    render(items.filter(i => (i.title || "").toLowerCase().includes(query) || (i.content || "").toLowerCase().includes(query)));
}

function togglePopup() {
    const overlay = document.getElementById('choice-popup');
    const fab = document.getElementById('main-fab');
    if(!overlay.classList.contains('active')) {
        overlay.style.display = 'flex';
        fab.classList.add('active');
        setTimeout(() => overlay.classList.add('active'), 10);
    } else {
        overlay.classList.remove('active');
        fab.classList.remove('active');
        setTimeout(() => overlay.style.display = 'none', 300);
    }
}

function openForm(type) {
    currentType = type; togglePopup();
    document.getElementById('title').value = ''; document.getElementById('content').value = '';
    document.getElementById('preview-img').style.display = 'none'; document.getElementById('audio-preview').style.display = 'none';
    document.getElementById('record-btn').style.display = type === 'vocale' ? 'flex' : 'none';
    if(type === 'image' && currentMediaData) { document.getElementById('preview-img').src = currentMediaData; document.getElementById('preview-img').style.display = 'block'; }
    document.getElementById('modal-overlay').style.display = 'flex';
    setTimeout(() => document.getElementById('modal-overlay').classList.add('active'), 10);
}

function closeForm() {
    document.getElementById('modal-overlay').classList.remove('active');
    setTimeout(() => { document.getElementById('modal-overlay').style.display = 'none'; currentMediaData = null; }, 300);
}

function save() {
    const t = document.getElementById('title').value.trim(); const c = document.getElementById('content').value.trim();
    if(!t && !c && !currentMediaData) return;
    const now = new Date(); const d = `${now.getDate().toString().padStart(2,'0')}.${(now.getMonth()+1).toString().padStart(2,'0')}.${now.getFullYear().toString().slice(-2)}`;
    items.unshift({ title: t, content: c, type: currentType, date: d, pinned: false, media: currentMediaData });
    saveToDisk(); closeForm();
}

function saveToDisk() { items.sort((a,b) => b.pinned - a.pinned); localStorage.setItem('essential_space_v2', JSON.stringify(items)); render(); }

function handleImageClick() { togglePopup(); document.getElementById('image-input').click(); }
document.getElementById('image-input').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => { currentMediaData = ev.target.result; openForm('image'); };
    reader.readAsDataURL(e.target.files[0]);
};

async function toggleRecording() {
    const btn = document.getElementById('record-btn');
    if(!isRecording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream); audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.onload = ev => { currentMediaData = ev.target.result; document.getElementById('audio-preview').src = ev.target.result; document.getElementById('audio-preview').style.display = 'block'; };
            reader.readAsDataURL(blob);
        };
        mediaRecorder.start(); isRecording = true; btn.classList.add('recording'); btn.innerText = "ARRÊTER";
    } else { mediaRecorder.stop(); isRecording = false; btn.classList.remove('recording'); btn.innerText = "REPRENDRE"; }
}

function startPress(i, e) {
    if(e.target.tagName === 'AUDIO') return;
    selectedIndex = i; e.currentTarget.classList.add('pressing');
    pressTimer = setTimeout(() => {
        e.currentTarget.classList.remove('pressing');
        document.getElementById('pin-text').innerHTML = items[i].pinned ? '<span class="material-icons-round">push_pin</span> Détacher' : '<span class="material-icons-round">push_pin</span> Épingler';
        document.getElementById('context-overlay').style.display = 'flex';
        if(navigator.vibrate) navigator.vibrate(50);
    }, 600);
}
function endPress(e) { clearTimeout(pressTimer); e.currentTarget.classList.remove('pressing'); }
function closeContextMenu() { document.getElementById('context-overlay').style.display = 'none'; }
function toggleHeaderMenu(show) { document.getElementById('header-menu-overlay').style.display = show ? 'flex' : 'none'; }

function handleMenuAction(action) {
    if(action === 'delete') items.splice(selectedIndex, 1);
    else items[selectedIndex].pinned = !items[selectedIndex].pinned;
    saveToDisk(); closeContextMenu();
}

async function exportData() {
    const data = JSON.stringify(items, null, 2);
    if(navigator.share) {
        const file = new File([data], 'essential_space.json', { type: 'application/json' });
        try { await navigator.share({ files: [file], title: 'Backup Essential Space' }); } catch(e) {}
    } else {
        const blob = new Blob([data], { type: "application/json" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click();
    }
}

function triggerImport() { document.getElementById('import-input').click(); }
function importData(e) {
    const reader = new FileReader();
    reader.onload = (ev) => { try { items = JSON.parse(ev.target.result); saveToDisk(); alert("Restauré !"); } catch(err) { alert("Invalide"); } };
    reader.readAsText(e.target.files[0]);
}
function clearAll() { if(confirm("Tout supprimer ?")) { items = []; saveToDisk(); toggleHeaderMenu(false); } }

render();
</script>
</body>
</html>
