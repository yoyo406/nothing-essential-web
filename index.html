<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Essential Space ‚Äî nothing-like lists</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<style>
:root{
  --bg: #000000;
  --card: #111111;
  --text-main: #FFFFFF;
  --text-dim: #999999;
  --accent-red: #EB4432;
  --border: #222222;
  --mono: 'Space Mono', monospace;
}
body.light-theme{
  --bg: #F5F5F5;
  --card: #FFFFFF;
  --text-main: #111111;
  --text-dim: #666666;
  --border: #E6E6E6;
}

/* Base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:var(--bg);
  color:var(--text-main);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding-bottom:140px;
}

/* Header */
.app-header{
  position:sticky;top:0;left:0;right:0;z-index:1000;
  background:rgba(0,0,0,0.75);backdrop-filter:blur(10px);
  padding:18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)
}
.logo{font-family:var(--mono);letter-spacing:2px;font-weight:700;font-size:14px}

/* Search */
.search-container{padding:14px 16px 0 16px}
.search-bar{
  display:flex;align-items:center;gap:12px;padding:12px;border-radius:18px;background:#0d0d0d;border:1px solid var(--border)
}
body.light-theme .search-bar{background:#f0f0f0;border-color:#e6e6e6}
.search-bar input{flex:1;background:transparent;border:none;outline:none;color:var(--text-main);font-size:15px}
.search-bar .material-icons-round{color:var(--text-dim)}

/* Grid */
.cards-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:20px}
.card{background:var(--card);border-radius:20px;padding:18px;min-height:120px;border:1px solid var(--border);display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;position:relative;overflow:hidden}
.card.pinned{box-shadow:0 6px 20px rgba(0,0,0,0.45)}
.pin-dot{position:absolute;top:12px;right:12px;width:8px;height:8px;border-radius:50%;background:var(--accent-red);box-shadow:0 0 8px var(--accent-red)}
.card-type{font-family:var(--mono);font-size:9px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px}
.card-title{font-weight:600;font-size:15px;color:var(--text-main);margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-content{font-size:13px;color:var(--text-main);line-height:1.4;max-height:3.6em;overflow:hidden}

/* Image/audio card */
.card-image{width:100%;height:88px;object-fit:cover;border-radius:12px;margin-bottom:10px}
.card-audio{width:100%;height:36px;margin-top:8px}

/* list preview in card */
.card-list{list-style:none;padding-left:0;margin:6px 0;font-size:13px}
.card-list-item{padding:4px 0;display:flex;align-items:center;gap:8px}
.card-list-item.checked{opacity:0.55;text-decoration:line-through;color:var(--text-dim)}

/* Speed dial + FAB */
.popup-overlay{position:fixed;inset:0;z-index:2000;display:none;align-items:flex-end;justify-content:flex-end;padding:24px}
.popup-overlay.active{display:flex;background:rgba(0,0,0,0.25);backdrop-filter:blur(8px)}
.speed-dial-list{display:flex;flex-direction:column;gap:12px;align-items:flex-end}
.dial-item{display:flex;align-items:center;gap:12px;padding:10px 16px;border-radius:100px;background:#141414;border:1px solid #222;cursor:pointer}
.dial-item .material-icons-round{font-size:20px;color:var(--text-main)}
.dial-label{font-family:var(--mono);font-size:12px;color:var(--text-main);text-transform:uppercase}

/* FAB */
.fab-container{position:fixed;right:22px;bottom:28px;z-index:2500}
.fab{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;color:#000;box-shadow:0 12px 30px rgba(0,0,0,0.45);cursor:pointer}
body.light-theme .fab{background:#111;color:#fff}
.fab.active{transform:rotate(45deg);background:var(--accent-red);color:#fff}

/* Modal sheet */
.modal-overlay{position:fixed;inset:0;z-index:2600;display:none;align-items:flex-end;justify-content:flex-end}
.modal-overlay.active{display:flex;background:rgba(0,0,0,0.6)}
.modal-sheet{width:100%;max-height:92vh;border-radius:22px 22px 0 0;padding:22px;background:var(--card);border-top:1px solid var(--border);overflow:auto;transform:translateY(100%);transition:transform .24s ease-out}
.modal-overlay.active .modal-sheet{transform:translateY(0)}
.modal-sheet input,.modal-sheet textarea{width:100%;padding:14px;border-radius:14px;border:1px solid var(--border);background:transparent;color:var(--text-main);margin-bottom:10px;font-size:15px;outline:none}
.modal-sheet textarea{min-height:120px;resize:vertical}
.save-btn{width:100%;padding:14px;border-radius:999px;border:none;background:#fff;color:#000;font-weight:700;cursor:pointer;font-family:var(--mono)}
body.light-theme .save-btn{background:#111;color:#fff}

/* Color picker */
.color-picker{display:flex;gap:10px;margin-bottom:14px}
.color-btn{width:30px;height:30px;border-radius:50%;border:2px solid transparent;cursor:pointer}
.color-btn.active{outline:2px solid var(--text-main);outline-offset:2px}
.color-btn.white-btn{border-color:#999}

/* Settings / tips */
.settings-overlay{position:fixed;inset:0;z-index:3000;display:none;flex-direction:column;background:var(--bg)}
.settings-overlay.active{display:flex}
.settings-header{display:flex;justify-content:space-between;align-items:center;padding:18px;border-bottom:1px solid var(--border)}
.settings-scroll{padding:16px;overflow:auto;flex:1}
.settings-item{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:12px;display:flex;align-items:center;gap:12px;cursor:pointer;margin-bottom:8px}
.settings-item-label{font-size:15px;color:var(--text-main)}

/* Tips */
.tips-overlay{position:fixed;inset:0;z-index:3500;display:none;flex-direction:column;background:var(--bg)}
.tips-overlay.active{display:flex}
.tips-header{display:flex;justify-content:space-between;align-items:center;padding:18px;border-bottom:1px solid var(--border)}

/* ---- NOTE LIST EDITOR : style "Nothing OS" minimaliste ---- */
.list-editor{display:flex;gap:8px;margin-bottom:12px;width:100%}
.list-editor input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text-main);font-size:14px}

/* container des √©l√©ments */
#list-items-container{display:flex;flex-direction:column;gap:10px;margin-top:8px}

/* chaque ligne d'√©l√©ment */
.list-item{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:8px 10px;
  border-radius:12px;
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.03);
}

/* label englobant checkbox + texte (alignement propre) */
.list-label{display:flex;align-items:center;gap:12px;flex:1;cursor:pointer;user-select:none;position:relative}

/* cacher la checkbox native mais la garder accessible */
.list-label input[type="checkbox"]{
  appearance:none;-webkit-appearance:none;
  width:0;height:0;position:absolute;opacity:0;pointer-events:none;
}

/* bo√Æte custom pour la checkbox */
.custom-box{
  width:20px;height:20px;border-radius:6px;border:2px solid rgba(255,255,255,0.12);background:transparent;display:inline-flex;align-items:center;justify-content:center;flex:0 0 20px;transition:all .14s cubic-bezier(.2,.9,.2,1);box-shadow:0 2px 6px rgba(0,0,0,0.25) inset;
}

/* checkmark (appara√Æt quand la checkbox est coch√©e) */
.list-label input[type="checkbox"]:checked + .custom-box{
  background:var(--accent-red);border-color:var(--accent-red);transform:scale(.98);
}
.list-label input[type="checkbox"]:checked + .custom-box::after{
  content:"";width:8px;height:8px;display:block;border-radius:1px;background:#fff;transform:rotate(45deg) translateY(-1px);
}

/* texte de l'√©l√©ment */
.list-text{color:var(--text-main);font-size:14px;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:Inter}

/* bouton supprimer */
.remove-btn{background:none;border:none;color:var(--text-dim);font-size:14px;cursor:pointer;padding:6px;border-radius:8px}
.remove-btn:hover{color:#fff;background:rgba(255,255,255,0.03)}

/* aper√ßu carte : √©l√©ments coch√©s barr√©s et att√©nu√©s */
.card-list{padding-left:12px;margin:6px 0;font-size:13px;color:var(--text-main);list-style:none}
.card-list li{padding:4px 0}
.card-list-item.checked{text-decoration:line-through;opacity:0.55;color:var(--text-dim)}

/* responsive */
@media (max-width:800px){.cards-grid{grid-template-columns:repeat(1,1fr);padding:14px}.fab{width:56px;height:56px}}
</style>
</head>
<body>

<header class="app-header">
  <div class="logo">ESSENTIAL SPACE</div>
  <div style="display:flex;align-items:center;gap:12px">
    <span class="material-icons-round" style="cursor:pointer;color:var(--text-dim)" onclick="toggleTips(true)">help_outline</span>
    <span class="material-icons-round" style="cursor:pointer;color:var(--text-dim)" onclick="toggleSettings(true)">settings</span>
  </div>
</header>

<div class="search-container">
  <div class="search-bar">
    <span class="material-icons-round">search</span>
    <input id="search-input" placeholder="Rechercher..." oninput="search(this.value)" />
  </div>
</div>

<main class="cards-grid" id="container">
  <!-- cartes g√©n√©r√©es en JS -->
</main>

<div class="fab-container">
  <div class="fab" id="main-fab" onclick="togglePopup()" title="Ajouter">
    <span class="material-icons-round" style="font-size:32px">add</span>
  </div>
</div>

<div class="popup-overlay" id="choice-popup" onclick="togglePopup()">
  <div class="speed-dial-list" onclick="event.stopPropagation()">
    <div class="dial-item" onclick="openForm('√©crit')">
      <span class="material-icons-round">notes</span><span class="dial-label">√âcrit</span>
    </div>
    <div class="dial-item" onclick="openForm('lien')">
      <span class="material-icons-round">link</span><span class="dial-label">Lien</span>
    </div>
    <div class="dial-item" onclick="handleImageClick()">
      <span class="material-icons-round">photo_library</span><span class="dial-label">Image</span>
    </div>
    <div class="dial-item" onclick="openForm('vocale')">
      <span class="material-icons-round" style="color:var(--accent-red)">mic</span><span class="dial-label">Vocale</span>
    </div>
    <div class="dial-item" onclick="openForm('liste')">
      <span class="material-icons-round">format_list_bulleted</span><span class="dial-label">Liste</span>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay" onclick="closeForm()">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div id="modal-label" style="font-family:var(--mono);font-size:10px;color:var(--text-dim);text-transform:uppercase;margin-bottom:12px">NOUVEAU</div>

    <input id="note-title" placeholder="Titre (optionnel)" />

    <img id="preview-img" alt="" style="width:100%;max-height:220px;object-fit:contain;display:none;border-radius:12px;margin-bottom:12px;border:1px solid var(--border)">

    <button id="record-btn" style="display:none;width:100%;padding:12px;border-radius:28px;border:none;background:var(--accent-red);color:#fff;font-family:var(--mono);font-weight:700;margin-bottom:12px" onclick="toggleRecording()">MICRO</button>

    <audio id="audio-preview" controls style="display:none;width:100%;margin-bottom:12px"></audio>

    <textarea id="note-content" placeholder="Contenu..."></textarea>

    <!-- Liste editor -->
    <div id="list-editor-ui" style="display:none">
      <div class="list-editor">
        <input id="list-item-input" placeholder="Nouvel √©l√©ment" onkeydown="if(event.key==='Enter'){ addListItem(); }" />
        <button class="save-btn" style="width:auto;padding:10px 14px;border-radius:12px" onclick="addListItem()">AJOUTER</button>
      </div>
      <div id="list-items-container"></div>
    </div>

    <div class="color-picker" id="color-picker-ui">
      <div class="color-btn white-btn" id="cbtn-default" style="background:#FFFFFF" onclick="setTextColor('default')"></div>
      <div class="color-btn" id="cbtn-red" style="background:var(--accent-red)" onclick="setTextColor('#EB4432')"></div>
      <div class="color-btn" id="cbtn-yellow" style="background:#FFD700" onclick="setTextColor('#FFD700')"></div>
      <div class="color-btn" id="cbtn-green" style="background:#00FF7F" onclick="setTextColor('#00FF7F')"></div>
      <div class="color-btn" id="cbtn-blue" style="background:#00BFFF" onclick="setTextColor('#00BFFF')"></div>
    </div>

    <button class="save-btn" onclick="saveNote()">ENREGISTRER</button>

    <div class="action-bar" id="edit-actions" style="display:none;margin-top:12px">
      <button class="action-btn" id="pin-btn-modal" onclick="togglePinModal()" title="√âpingler">
        <span class="material-icons-round">push_pin</span>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim)">√âpingler</div>
      </button>
      <button class="action-btn delete" onclick="deleteNoteModal()" title="Supprimer">
        <span class="material-icons-round">delete</span>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim)">Supprimer</div>
      </button>
    </div>

    <button onclick="closeForm()" style="width:100%;background:none;border:none;color:var(--text-dim);margin-top:12px;font-size:13px;cursor:pointer">FERMER</button>
  </div>
</div>

<div class="settings-overlay" id="settings-overlay">
  <div class="settings-header">
    <div style="font-family:var(--mono);font-size:13px">‚öôÔ∏è Param√®tres</div>
    <button style="background:none;border:none;color:var(--text-dim);cursor:pointer" onclick="toggleSettings(false)"><span class="material-icons-round">close</span></button>
  </div>
  <div class="settings-scroll">
    <div style="margin-bottom:12px;font-family:var(--mono);font-size:12px;color:var(--text-dim)">Apparence</div>
    <div style="display:flex;gap:8px;margin-bottom:18px">
      <button id="theme-opt-dark" class="save-btn" style="flex:1;padding:10px" onclick="setThemeMode('dark')">Sombre</button>
      <button id="theme-opt-light" class="save-btn" style="flex:1;padding:10px" onclick="setThemeMode('light')">Clair</button>
      <button id="theme-opt-auto" class="save-btn" style="flex:1;padding:10px" onclick="setThemeMode('auto')">Auto</button>
    </div>

    <div style="margin-bottom:8px;font-family:var(--mono);font-size:12px;color:var(--text-dim)">Donn√©es</div>
    <div class="settings-item" onclick="exportData()">
      <span class="material-icons-round" style="color:var(--text-dim)">share</span>
      <div style="margin-left:8px">
        <div class="settings-item-label">Exporter les notes</div>
        <div style="font-size:12px;color:var(--text-dim)">Sauvegarde JSON</div>
      </div>
    </div>
    <div class="settings-item" onclick="triggerImport()">
      <span class="material-icons-round" style="color:var(--text-dim)">upload</span>
      <div style="margin-left:8px">
        <div class="settings-item-label">Importer des notes</div>
        <div style="font-size:12px;color:var(--text-dim)">Restaurer depuis JSON</div>
      </div>
    </div>
  </div>
</div>

<div class="tips-overlay" id="tips-overlay">
  <div class="tips-header">
    <div style="font-family:var(--mono);font-size:13px">üí° Astuces</div>
    <button style="background:none;border:none;color:var(--text-dim);cursor:pointer" onclick="toggleTips(false)"><span class="material-icons-round">close</span></button>
  </div>
  <div style="padding:16px;color:var(--text-dim);font-size:14px">
    <div style="margin-bottom:8px">Appuie sur <strong>+</strong> pour cr√©er une note. Choisis "Liste" pour la checklist.</div>
    <div style="margin-bottom:8px">Tu peux exporter/importer via ‚öôÔ∏è pour sauvegarder.</div>
  </div>
</div>

<input id="image-input" type="file" accept="image/*" style="display:none" />
<input id="import-input" type="file" accept=".json" style="display:none" onchange="importData(event)" />

<script>
/* √©tat global */
let items = JSON.parse(localStorage.getItem('essential_space_v3') || '[]') || [];
let currentType = '√©crit';
let currentMediaData = null;
let editingIndex = null;
let selectedColor = null;
let mediaRecorder = null, audioChunks = [], isRecording = false;
let listItems = [];

let themeMode = localStorage.getItem('essential_theme_mode') || 'auto';

function isCurrentlyDark(){
  return themeMode === 'dark' || (themeMode === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
}

function applyTheme(){
  const dark = isCurrentlyDark();
  document.body.classList.toggle('light-theme', !dark);
  document.querySelector('meta[name="theme-color"]').setAttribute('content', dark ? '#000000' : '#F5F5F5');
  ['dark','light','auto'].forEach(m => {
    const el = document.getElementById('theme-opt-' + m);
    if (!el) return;
    el.style.outline = (themeMode === m) ? '3px solid rgba(235,68,50,0.9)' : 'none';
  });
  render();
}
setTimeout(()=>{ if (window.matchMedia) window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=> { if (themeMode==='auto') applyTheme(); })},100);

/* utilitaires */
function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function defaultColor(){ return isCurrentlyDark() ? '#FFFFFF' : '#111111'; }

/* render */
function render(data = items){
  const container = document.getElementById('container');
  if (!Array.isArray(data) || data.length === 0){
    container.innerHTML = '<div style="grid-column:span 2;text-align:center;padding:60px;color:var(--text-dim);font-family:var(--mono);font-size:12px">ESPACE VIDE</div>';
    return;
  }

  container.innerHTML = data.map((item,i) => {
    const spanStyle = (item.type==='image' || item.type==='vocale') ? 'grid-column:span 2;' : '';
    const textColor = item.color || 'var(--text-main)';

    let contentHtml = '';
    if (item.type === 'image' && item.media){
      contentHtml = `<img src="${item.media}" class="card-image" alt="">` +
                    `<div class="card-content" style="color:${textColor}">${escapeHtml(item.content||'')}</div>`;
    } else if (item.type === 'vocale' && item.media){
      contentHtml = `<audio src="${item.media}" class="card-audio" controls onclick="event.stopPropagation()"></audio>` +
                    `<div class="card-content" style="color:${textColor}">${escapeHtml(item.content||'')}</div>`;
    } else if (item.type === 'liste' && Array.isArray(item.items)){
      const listHtml = item.items.slice(0,4).map(li => `<li class="card-list-item ${li.checked ? 'checked' : ''}">${escapeHtml(li.text)}</li>`).join('');
      contentHtml = `<ul class="card-list">${listHtml}${item.items.length>4?'<li style="opacity:0.6">‚Ä¶</li>':''}</ul>`;
    } else {
      contentHtml = `<div class="card-content" style="color:${textColor}">${escapeHtml(item.content||'')}</div>`;
    }

    return `
      <div class="card ${item.pinned ? 'pinned' : ''}" style="${spanStyle}" onclick="openEdit(${i})">
        ${item.pinned ? '<div class="pin-dot"></div>' : ''}
        <div>
          <div class="card-type">${escapeHtml(item.type)}</div>
          ${item.title ? `<div class="card-title">${escapeHtml(item.title)}</div>` : ''}
          ${contentHtml}
        </div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-top:8px">${escapeHtml(item.date||'')}</div>
      </div>
    `;
  }).join('');
}

/* palette */
const COLOR_TO_BTN = { 'default':'cbtn-default', '#EB4432':'cbtn-red', '#FFD700':'cbtn-yellow', '#00FF7F':'cbtn-green', '#00BFFF':'cbtn-blue' };
function setTextColor(color){
  selectedColor = (color==='default') ? null : color;
  document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
  const btnId = COLOR_TO_BTN[color] || 'cbtn-default';
  const btn = document.getElementById(btnId);
  if (btn) btn.classList.add('active');
  const ta = document.getElementById('note-content');
  if (ta) ta.style.color = selectedColor || defaultColor();
}

/* modal layout */
function applyModalLayout(type){
  const vocale = type==='vocale';
  const liste = type==='liste';
  document.getElementById('note-content').style.display = (vocale||liste) ? 'none' : 'block';
  document.getElementById('color-picker-ui').style.display = (vocale||liste) ? 'none' : 'flex';
  document.getElementById('record-btn').style.display = vocale ? 'block' : 'none';
  document.getElementById('preview-img').style.display = (type==='image' && currentMediaData) ? 'block' : ((type==='image') ? 'none' : (document.getElementById('preview-img').src ? 'block' : 'none'));
  document.getElementById('list-editor-ui').style.display = liste ? 'block' : 'none';
}

/* reset modal */
function resetModal(){
  document.getElementById('note-title').value = '';
  document.getElementById('note-content').value = '';
  document.getElementById('preview-img').src = '';
  document.getElementById('preview-img').style.display = 'none';
  document.getElementById('audio-preview').src = '';
  document.getElementById('audio-preview').style.display = 'none';
  document.getElementById('edit-actions').style.display = 'none';
  document.getElementById('record-btn').style.display = 'none';
  document.getElementById('note-content').style.display = 'block';
  document.getElementById('color-picker-ui').style.display = 'flex';
  document.getElementById('list-editor-ui').style.display = 'none';
  document.getElementById('list-items-container').innerHTML = '';
  currentMediaData = null;
  listItems = [];
  setTextColor('default');
}

/* open new form */
function openForm(type){
  editingIndex = null;
  currentType = type;
  togglePopup();
  resetModal();
  document.getElementById('modal-label').innerText = 'NOUVEAU';
  applyModalLayout(type);
  showModal();
}

/* open edit */
function openEdit(index){
  editingIndex = index;
  const item = items[index];
  if (!item) return;
  resetModal();
  document.getElementById('modal-label').innerText = 'MODIFIER';
  document.getElementById('note-title').value = item.title || '';
  document.getElementById('edit-actions').style.display = 'flex';
  document.getElementById('pin-btn-modal').classList.toggle('active', !!item.pinned);
  currentType = item.type;
  applyModalLayout(item.type);

  if (item.type !== 'vocale' && item.type !== 'liste'){
    document.getElementById('note-content').value = item.content || '';
    setTextColor(item.color || 'default');
  }

  if (item.type === 'image' && item.media){
    document.getElementById('preview-img').src = item.media;
    document.getElementById('preview-img').style.display = 'block';
    currentMediaData = item.media;
  }
  if (item.type === 'vocale' && item.media){
    document.getElementById('audio-preview').src = item.media;
    document.getElementById('audio-preview').style.display = 'block';
    currentMediaData = item.media;
  }

  if (item.type === 'liste'){
    listItems = Array.isArray(item.items) ? item.items.map(li => ({text:li.text,checked:!!li.checked})) : [];
    renderListEditor();
  }

  showModal();
}

/* list editor functions */
function addListItem(){
  const input = document.getElementById('list-item-input');
  const text = (input.value || '').trim();
  if (!text) return;
  listItems.push({text,checked:false});
  input.value = '';
  renderListEditor();
}

function removeListItem(idx){
  listItems.splice(idx,1);
  renderListEditor();
}

function toggleListItemChecked(idx){
  listItems[idx].checked = !listItems[idx].checked;
  renderListEditor();
}

function renderListEditor(){
  const container = document.getElementById('list-items-container');
  container.innerHTML = '';
  listItems.forEach((li,i) => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <label class="list-label">
        <input type="checkbox" ${li.checked ? 'checked' : ''} onchange="toggleListItemChecked(${i})" aria-label="Marquer">
        <span class="custom-box"></span>
        <span class="list-text">${escapeHtml(li.text)}</span>
      </label>
      <button class="remove-btn" onclick="removeListItem(${i})" title="Supprimer">‚úï</button>
    `;
    container.appendChild(div);
  });
}

/* save note */
function saveNote(){
  const title = document.getElementById('note-title').value.trim();
  const content = document.getElementById('note-content').value.trim();
  const now = new Date();
  const date = `${String(now.getDate()).padStart(2,'0')}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getFullYear()).slice(-2)}`;

  const base = {
    title,
    type: currentType,
    date,
    color: selectedColor,
    media: currentMediaData || (editingIndex!==null ? items[editingIndex].media : null),
    pinned: editingIndex!==null ? !!items[editingIndex].pinned : false,
  };

  if (currentType === 'liste'){
    base.items = listItems.map(li => ({text:li.text,checked:!!li.checked}));
    base.content = '';
  } else {
    base.content = content;
    base.items = undefined;
  }

  const note = base;

  if (editingIndex !== null){
    items[editingIndex] = note;
  } else {
    items.unshift(note);
  }

  saveToDisk();
  closeForm();
}

/* toggle pin & delete */
function togglePinModal(){
  if (editingIndex===null) return;
  items[editingIndex].pinned = !items[editingIndex].pinned;
  document.getElementById('pin-btn-modal').classList.toggle('active', items[editingIndex].pinned);
  saveToDisk();
}

function deleteNoteModal(){
  if (editingIndex===null) return;
  if (!confirm('Supprimer cette note ?')) return;
  items.splice(editingIndex,1);
  saveToDisk();
  closeForm();
}

/* modal helpers */
function showModal(){
  const overlay = document.getElementById('modal-overlay');
  overlay.style.display = 'flex';
  setTimeout(()=>overlay.classList.add('active'),20);
}

function closeForm(){
  const overlay = document.getElementById('modal-overlay');
  overlay.classList.remove('active');
  setTimeout(()=>{ overlay.style.display = 'none'; },240);
}

/* popup */
function togglePopup(){
  const popup = document.getElementById('choice-popup');
  const fab = document.getElementById('main-fab');
  if (!popup.classList.contains('active')){
    popup.classList.add('active');
    document.getElementById('choice-popup').style.display = 'flex';
    fab.classList.add('active');
  } else {
    popup.classList.remove('active');
    setTimeout(()=>{ document.getElementById('choice-popup').style.display = 'none'; },220);
    fab.classList.remove('active');
  }
}
function toggleSettings(s){ document.getElementById('settings-overlay').classList.toggle('active', !!s); }
function toggleTips(s){ document.getElementById('tips-overlay').classList.toggle('active', !!s); }

/* persistence */
function saveToDisk(){
  // √©pingl√©s en haut
  items.sort((a,b)=> (b.pinned?1:0)-(a.pinned?1:0));
  localStorage.setItem('essential_space_v3', JSON.stringify(items));
  render();
}

/* search */
function search(q){
  const query = (q||'').toLowerCase().trim();
  if (!query) { render(); return; }
  render(items.filter(i => {
    const title = (i.title||'').toLowerCase();
    const content = (i.content||'').toLowerCase();
    const itemsText = Array.isArray(i.items) ? i.items.map(x => x.text).join(' ').toLowerCase() : '';
    return (title + ' ' + content + ' ' + itemsText).includes(query);
  }));
}

/* export/import */
function exportData(){
  const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'essential_space_' + new Date().toISOString().slice(0,10) + '.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toggleSettings(false);
}

function triggerImport(){ document.getElementById('import-input').click(); }
function importData(event){
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!Array.isArray(imported)) { alert('Fichier invalide.'); return; }
      items = imported;
      saveToDisk();
      toggleSettings(false);
      alert(imported.length + ' note(s) import√©e(s) avec succ√®s.');
    } catch (e){
      alert('Erreur de lecture du fichier JSON.');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

/* image handling */
function handleImageClick(){
  togglePopup();
  document.getElementById('image-input').click();
}
document.getElementById('image-input').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    currentMediaData = ev.target.result;
    openForm('image');
    setTimeout(()=>{ document.getElementById('preview-img').src = currentMediaData; document.getElementById('preview-img').style.display='block'; },40);
  };
  reader.readAsDataURL(file);
  e.target.value = '';
};

/* audio recording */
async function toggleRecording(){
  const btn = document.getElementById('record-btn');
  if (!isRecording){
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type:'audio/webm' });
        const reader = new FileReader();
        reader.onload = ev => {
          currentMediaData = ev.target.result;
          const audio = document.getElementById('audio-preview');
          audio.src = ev.target.result;
          audio.style.display = 'block';
        };
        reader.readAsDataURL(blob);
        stream.getTracks().forEach(t=>t.stop());
      };
      mediaRecorder.start();
      isRecording = true;
      btn.innerText = 'STOP';
    } catch (err){
      alert('Acc√®s au microphone refus√©.');
    }
  } else {
    mediaRecorder.stop();
    isRecording = false;
    btn.innerText = 'MICRO';
  }
}

/* init */
function setThemeMode(mode){ themeMode = mode; localStorage.setItem('essential_theme_mode', mode); applyTheme(); }
applyTheme();
render();
</script>
</body>
</html>
